---
layout: post
title:  "2022_likelion TIL"
date:   2022-10-04 09:00:09 +0900
categories: Python_DataAnalysis
---
# [ 1004 ] ì›¹ ë°ì´í„° ìˆ˜ì§‘
#### ğŸ‘©ğŸ»â€ğŸ’» ì˜¤ëŠ˜ì½”ë“œ ì‹¤ì‹œê°„ ê°•ì˜ _ ë°•ì¡°ì€ë‹˜
ì˜¤ëŠ˜ì€ [ì„œìš¸ì •ë³´ì†Œí†µê´‘ì¥](https://opengov.seoul.go.kr/civilappeal/list)ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ì˜ˆì •ì´ë‹¤. ë§í¬ ì•ˆì˜ ë‚´ìš©ê¹Œì§€ ê°€ì ¸ì˜¬ ê²ƒ!

### ğŸ¾ã€€ì‹¤ìŠµ ì „ í•„ìš”í•œ ë„êµ¬ ì„¤ì¹˜í•˜ê¸°ã€€ğŸ¾

**Requests** - ì‘ì€ ë¸Œë¼ìš°ì €ë¡œ ì›¹ì‚¬ì´íŠ¸ë¥¼ ì½ì–´ì˜¨ë‹¤. <br/>
```shell
conda install -c anaconda requests
```

**Beautifulsoup4** - ì½ì–´ì˜¨ ì›¹ ì‚¬ì´íŠ¸ë¥¼ í•´ì„í•œë‹¤. <br/>
```shell
conda install -c anaconda beautifulsoup4
```

**Tqdm** - ì§„í–‰ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ëª©ì  <br/>
```shell
conda install -c conda-forge tqdm
```



### ğŸ¾ã€€HTTP ìƒíƒœ ì½”ë“œã€€ğŸ¾
**1xx (ì •ë³´)**: ìš”ì²­ì„ ë°›ì•˜ìœ¼ë©° í”„ë¡œì„¸ìŠ¤ë¥¼ ê³„ì†í•œë‹¤ <br/>
**2xx (ì„±ê³µ)**: ìš”ì²­ì„ ì„±ê³µì ìœ¼ë¡œ ë°›ì•˜ìœ¼ë©° ì¸ì‹í–ˆê³  ìˆ˜ìš©í•˜ì˜€ë‹¤ <br/>
**3xx (ë¦¬ë‹¤ì´ë ‰ì…˜)**: ìš”ì²­ ì™„ë£Œë¥¼ ìœ„í•´ ì¶”ê°€ ì‘ì—… ì¡°ì¹˜ê°€ í•„ìš”í•˜ë‹¤ <br/>
**4xx (í´ë¼ì´ì–¸íŠ¸ ì˜¤ë¥˜)**: ìš”ì²­ì˜ ë¬¸ë²•ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ë‹¤ <br/>
**5xx (ì„œë²„ ì˜¤ë¥˜)**: ì„œë²„ê°€ ëª…ë°±íˆ ìœ íš¨í•œ ìš”ì²­ì— ëŒ€í•´ ì¶©ì¡±ì„ ì‹¤íŒ¨í–ˆë‹¤ <br/><br/>
-> ë” ìì„¸í•œ ì„¤ëª…ì€ [ìœ„í‚¤í”¼ë””ì•„](https://ko.wikipedia.org/wiki/HTTP_100%EC100%83100%81100%ED100%83100%9C_100%EC100%BD100%94100%EB100%93100%9C)ë¥¼ ì°¸ê³ í•˜ì.


### ğŸ¾ã€€ì„œìš¸120 ë°ì´í„° ìˆ˜ì§‘ã€€ğŸ¾
1. Inspect > Network > Request urlì„ ì°¸ê³ í•´ ì›í•˜ëŠ” í˜ì´ì§€ì˜ urlì„ ì•Œì•„ë‚¸ë‹¤.
2. requestsë¥¼ í†µí•´ http í†µì‹ ìœ¼ë¡œ ì›í•˜ëŠ” urlì— ìš”ì²­ì„ ë³´ë‚´ ì‘ë‹µì„ ë°›ì•„ì˜¨ë‹¤.
3. ë°ì´í„°ê°€ ì—†ëŠ” í˜ì´ì§€ì˜ ê²½ìš° ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•´ì¤€ë‹¤.
4. ì—†ëŠ” í˜ì´ì§€ê°€ ì•„ë‹ˆë¼ë©´ ë§í¬ ë²ˆí˜¸ ìˆ˜ì§‘ì„ ìœ„í•´ a íƒœê·¸ì˜ href ë¶€ë¶„ì„ ì°¸ê³ í•´ "ë‚´ìš© ë²ˆí˜¸"ì— ë²ˆí˜¸ë¥¼ ë„£ì–´ì¤€ë‹¤.
5. ë°˜ë³µë¬¸ì„ í™œìš©í•˜ì—¬ ìœ„ì˜ ë‚´ìš©ì„ ë°˜ë³µí•˜ì—¬ ë¯¼ì› ì œëª©ê³¼ ë‚´ìš© ë“±ì„ ë°›ì•„ì˜¨ë‹¤.
6. ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ëª©ë¡ + ë³¸ë¬¸ìœ¼ë¡œ ë°ì´í„°í”„ë ˆì„ í˜•íƒœë¡œ ì—°ê²°í•œë‹¤.

<br/>

### ğŸ’¡ **tqdm**ì€ ëª©ë¡ì„ ìˆ˜ì§‘í•  ë•Œ ì‚¬ìš©í•˜ê¸° ì–´ë µë‹¤. ê·¸ ì´ìœ ëŠ” ë­˜ê¹Œ?
ë²”ìœ„ê°€ ì •í•´ì ¸ ìˆì§€ ì•Šì•„ì„œ.


### ğŸ¾ã€€ì„œìš¸íŠ¹ë³„ì‹œ ë‹¤ì‚°ì½œì„¼í„°(120)ì˜ ì£¼ìš” ë¯¼ì›ì— ëŒ€í•œ ë‹µë³€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ìã€€ğŸ¾
#### ìƒì„¸ í˜ì´ì§€ ì ‘ê·¼ì„ ìœ„í•´ a íƒœê·¸ ì•ˆì˜ ë§í¬ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜¤ì.
```python
# 120 ë‹¤ì‚° ì½œì„¼í„°ì˜ ì²« í˜ì´ì§€ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ í¬ë¡¤ë§í•  ë‚´ìš© í™•ì¸
# items_per_page ê°’ì„ ì¡°ì ˆí•´ ëª‡ ê°œì”© ë³¼ ê±´ì§€ ì§€ì •
base_url = "https://opengov.seoul.go.kr/civilappeal/list?items_per_page=50&page=1"
print(base_url)
```

pd.read_htmlì„ ì´ìš©í•´ base_urlì˜ table ì •ë³´ë¥¼ ë°›ì•„ì˜¤ì.
```python
table = pd.read_html(base_url, encoding = "utf-8")
table[0].head(/assets/img/img_221004/.png){:width="100%" height="100%"}
```

ì˜ ë°›ì•„ì˜¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ ìƒì„¸ ì •ë³´ ë§í¬ê°€ ì—†ê¸° ë•Œë¬¸ì— **requests**ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ë„ë¡ í•˜ê² ë‹¤.


```python
# a íƒœê·¸ ì•ˆì˜ ìƒì„¸ í˜ì´ì§€ ì ‘ê·¼ì„ ìœ„í•œ ë§í¬ ë²ˆí˜¸ ìˆ˜ì§‘
html = bs(response.text)
html.select("td.data-title.aLeft > a")

a_link_no = []
for a_tag in a_list:
    a_link_no.append(a_tag["href"].split('/')[-1])
a_link_no[:5]
```

**a_link_no** ê°’ì„ "ë‚´ìš©ë²ˆí˜¸" ì»¬ëŸ¼ì— ë„£ì–´ì£¼ì.
```python
table[0]["ë‚´ìš©ë²ˆí˜¸"] = a_link_no
table[0].head(/assets/img/img_221004/.png){:width="100%" height="100%"}
```

#### íŠ¹ì • í˜ì´ì§€ë¥¼ ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜ ë§Œë“¤ê¸°
```python
def get_one_page(items_per_page, page_no):
    """
    120 ì£¼ìš”ì§ˆë¬¸ì˜ íŠ¹ì • í˜ì´ì§€ ëª©ë¡ì„ ìˆ˜ì§‘
    1. pageë§ˆë‹¤ urlì´ ë³€ê²½ë˜ë„ë¡ f-stringì„ ì´ìš©í•œë‹¤.
    2. requestsë¥¼ í†µí•´ http í†µì‹ ìœ¼ë¡œ ì›í•˜ëŠ” urlì— ìš”ì²­ì„ ë³´ë‚´ ì‘ë‹µì„ ë°›ì•„ì˜¨ë‹¤.
    3. pd.read_htmlì„ ì‚¬ìš©í•´ì„œ table tagë¡œ ê²Œì‹œë¬¼ì„ ì½ì–´ì˜¨ë‹¤.
    4. 3ë²ˆ ê²°ê³¼ì˜ 0ë²ˆ ì¸ë±ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ëª©ë¡ + ë³¸ë¬¸ìœ¼ë¡œ ë°ì´í„°í”„ë ˆì„ í˜•íƒœë¡œ ì—°ê²°í•œë‹¤.
    5. html tagë¥¼ íŒŒì‹±í•  ìˆ˜ ìˆê²Œ bs ì´ìš©
    6. ëª©ë¡ ì•ˆì— ìˆëŠ” a tagë¥¼ ì°¾ëŠ”ë‹¤.
    7. a tag ì•ˆ hrefì—ì„œ ë‚´ìš©ë²ˆí˜¸ë§Œ ë°›ì•„ì™€ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥í•œë‹¤.
    8. ë‚´ìš©ë²ˆí˜¸ ì»¬ëŸ¼ì„ ë§Œë“¤ê³  a tagì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•œë‹¤.
    """
    
    # url ì„¤ì • ë° ì‘ë‹µ ë°›ì•„ì˜¤ê¸°
    url = f"https://opengov.seoul.go.kr/civilappeal/list?items_per_page={items_per_page}&page={page_no}"
    response = requests.get(url)

    # table tag
    table = pd.read_html(response.text)[0]

    # tag parsing í•  ìˆ˜ ìˆê²Œ bs ì´ìš©
    html = bs(response.text)

    # a tag ì•ˆ hrefì—ì„œ ë‚´ìš©ë²ˆí˜¸ë§Œ ë°›ì•„ì™€ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥
    a_list = html.select("td.data-title.aLeft > a")
    a_link_no = []
    for a_tag in a_list:
        a_link_no.append(a_tag["href"].split('/')[-1])
    
    # tableì— ë‚´ìš©ë²ˆí˜¸ ì»¬ëŸ¼ì„ ë§Œë“¤ê³  ì¶”ê°€
    table["ë‚´ìš©ë²ˆí˜¸"] = a_link_no
    
    
    return table
```
```python
# í•¨ìˆ˜ê°€ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
get_one_page(items_per_page=15, page_no=5)
```
![get_one_page_1004](/assets/img/img_221004/get_one_page_1004.png){:width="100%" height="100%"} <br/><br/>


#### ì—†ëŠ” í˜ì´ì§€ë¥¼ ì§€ì •í•´ì£¼ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
```python
# ì—†ëŠ” í˜ì´ì§€ë„ í™•ì¸
get_one_page(items_per_page=50, page_no=500)
```
-> ValueError : Length of values (0) does not match length of index (1)
<br/>

#### ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•´ì£¼ë„ë¡ í•˜ì. 
**`iterms_per_page`**ë¥¼ `50`ìœ¼ë¡œ ì„¤ì •í•˜ê³  `500` í˜ì´ì§€ë¥¼ ë³´ê³ ì í•  ë•ŒëŠ” ì—†ëŠ” í˜ì´ì§€ë¯€ë¡œ, ìœ„ì™€ ê°™ì€ **`ValueError`**ê°€ ë°œìƒí•œë‹¤. ë˜, **`iterms_per_page`**ë¥¼ `50`ìœ¼ë¡œ ì„¤ì •í•˜ê³  `200` í˜ì´ì§€ë¥¼ ë³´ê³ ì í•  ë•ŒëŠ” ë°ì´í„°ê°€ ì—†ëŠ” ë¹ˆ ë°ì´í„°í”„ë ˆì„ì´ ì¶œë ¥ì´ ëœë‹¤. ì´ ê²½ìš°ë¥¼ ì˜ˆì™¸ì²˜ë¦¬í•´ì£¼ë„ë¡ í•˜ì. 
```python
def get_one_page(items_per_page, page_no):
    """
    120 ì£¼ìš”ì§ˆë¬¸ì˜ íŠ¹ì • í˜ì´ì§€ ëª©ë¡ì„ ìˆ˜ì§‘
    1. pageë§ˆë‹¤ urlì´ ë³€ê²½ë˜ë„ë¡ f-stringì„ ì´ìš©í•œë‹¤.
    2. requestsë¥¼ í†µí•´ http í†µì‹ ìœ¼ë¡œ ì›í•˜ëŠ” urlì— ìš”ì²­ì„ ë³´ë‚´ ì‘ë‹µì„ ë°›ì•„ì˜¨ë‹¤.
    3. pd.read_htmlì„ ì‚¬ìš©í•´ì„œ table tagë¡œ ê²Œì‹œë¬¼ì„ ì½ì–´ì˜¨ë‹¤.
    4. 3ë²ˆ ê²°ê³¼ì˜ 0ë²ˆ ì¸ë±ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ëª©ë¡ + ë³¸ë¬¸ìœ¼ë¡œ ë°ì´í„°í”„ë ˆì„ í˜•íƒœë¡œ ì—°ê²°í•œë‹¤.
    5. html tagë¥¼ íŒŒì‹±í•  ìˆ˜ ìˆê²Œ bs ì´ìš©
    6. ëª©ë¡ ì•ˆì— ìˆëŠ” a tagë¥¼ ì°¾ëŠ”ë‹¤.
    7. a tag ì•ˆ hrefì—ì„œ ë‚´ìš©ë²ˆí˜¸ë§Œ ë°›ì•„ì™€ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥í•œë‹¤.
    8. ë‚´ìš©ë²ˆí˜¸ ì»¬ëŸ¼ì„ ë§Œë“¤ê³  a tagì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•œë‹¤.
    """
    
    # url ì„¤ì • ë° ì‘ë‹µ ë°›ì•„ì˜¤ê¸°
    url = f"https://opengov.seoul.go.kr/civilappeal/list?items_per_page={items_per_page}&page={page_no}"
    response = requests.get(url)

    # table tag
    table = pd.read_html(response.text)[0]


    ## ì˜ˆì™¸ ì²˜ë¦¬ ##
    # ValueErrorê°€ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ 200 í˜ì´ì§€ì¸ ê²½ìš° ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
    if table.shape[0] == 0:
        return f"{page_no}í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    # ì—†ëŠ” í˜ì´ì§€ì— ëŒ€í•œ ValueError ì²˜ë¦¬
    try:
        # tag parsing í•  ìˆ˜ ìˆê²Œ bs ì´ìš©
        html = bs(response.text)

        # a tag ì•ˆ hrefì—ì„œ ë‚´ìš©ë²ˆí˜¸ë§Œ ë°›ì•„ì™€ ë¦¬ìŠ¤íŠ¸ì— ì €ì¥
        a_list = html.select("td.data-title.aLeft > a")
        
        # tableì— ë‚´ìš©ë²ˆí˜¸ ì»¬ëŸ¼ì„ ë§Œë“¤ê³  ì¶”ê°€
        table["ë‚´ìš©ë²ˆí˜¸"] = [a_tag["href"].split('/')[-1] for a_tag in a_list]
    except:
        return f"{page_no}í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    
    return table
```

```python
# ì—†ëŠ” í˜ì´ì§€ë„ í™•ì¸
get_one_page(items_per_page=50, page_no=200)
get_one_page(items_per_page=50, page_no=500)
# -> 200í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
# -> 500í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
```


#### ì˜ˆì™¸ì²˜ë¦¬
**`raise`** ë¬¸ì„ í†µí•´ ì¤‘ê°„ì— ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•´ì•¼í•  ë•ŒëŠ” ì˜ˆì™¸ ë©”ì‹œì§€ë§Œ ì¶œë ¥í•˜ëŠ” ë°©ë²•ë„ ìˆë‹¤.  <br/>
**`try - except`** ë¬¸ì€ ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì œê³µí•˜ë©´ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ë•Œì— ë¡œê·¸ë¥¼ ë‚¨ê¸¸ ë•Œ ì‚¬ìš©í•œë‹¤. <br/>
cross-site scriptingê³¼ ê°™ì€ ë³´ì•ˆ ìƒì˜ ì´ìŠˆë¥¼ ê³ ë ¤í•´ì„œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ì§„í–‰í•´ì£¼ì–´ì•¼í•œë‹¤. 


#### get_one_page í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ë°˜ë³µë¬¸ì„ í†µí•œ ì—¬ëŸ¬ í˜ì´ì§€ ìˆ˜ì§‘í•˜ê¸°

```python
# ê²Œì‹œë¬¼ì´ ì—†ìœ¼ë©´ ë©ˆì¶¥ë‹ˆë‹¤.
page_no = 40
items_per_page = 50
table_list = []

while True:
    df_tmp = get_one_page(items_per_page, page_no)

    if type(df_tmp) == str:
        print("ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        break
    print(page_no, end = ', ')
    df_tmp['í˜ì´ì§€'] = page_no
    table_list.append(df_tmp)
    page_no += 1

    # ì„œë²„ì— ë¶€ë‹´ì„ ì£¼ì§€ ì•Šê¸° ìœ„í•´ delay
    time.sleep(0.01)
```

#### ë°ì´í„° ë³‘í•©í•˜ê¸°
ì´ë ‡ê²Œ í˜ì´ì§€ë³„ë¡œ ëª¨ì€ ë°ì´í„°ë¥¼ í•˜ë‚˜ë¡œ ë³‘í•©í•´ë³´ì.
```python
df = pd.concat(table_list)
df
```
![get_pages_120](/assets/img/img_221004/get_pages_120.png){:width="100%" height="100%"} <br/><br/>

reset_indexë¥¼ ì§„í–‰í•´ì£¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì˜¨ë‹¤.
![get_pages_120_reset](/assets/img/img_221004/get_pages_120_reset.png){:width="100%" height="100%"} <br/><br/>

#### íŒŒì¼ë¡œ ì €ì¥í•˜ê³  ì €ì¥ëœ íŒŒì¼ í™•ì¸í•˜ê¸°
![final_df](/assets/img/img_221004/final_df.png){:width="100%" height="100%"} <br/><br/>

### ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ ë§Œë‚˜ìš” ğŸ™Œ
ë’· ë‚´ìš©ì€ [**[1004] ì„œìš¸ íŠ¹ë³„ì‹œ ë‹¤ì‚°ì½œì„¼í„° (â˜ 120) ì˜ ì£¼ìš” ë¯¼ì›ì— ëŒ€í•œ ë‹µë³€ ì •ë³´**](https://seul1230.github.io/2022_likelion/2022-10-04-likelion-TIL2/)ì—ì„œ ì´ì–´ì„œ ì‘ì„±í•œë‹¤.



<!-- ### ğŸ¾ã€€ã€€ğŸ¾
### ğŸ¾ã€€ã€€ğŸ¾
### ğŸ¾ã€€ã€€ğŸ¾
### ğŸ¾ã€€ã€€ğŸ¾
### ğŸ¾ã€€ã€€ğŸ¾
### ğŸ¾ã€€ã€€ğŸ¾ -->
